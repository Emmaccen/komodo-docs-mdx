# Lightning Network Initialization Tasks

<Note>
Lightning methods are currently only available using the native AtomicDEX-API. WASM support should be available in late 2023.
</Note>

## init

The `task::enable_lightning::init` request a task to run a lightning node. Use the returned `task_id` as an input to check the status of the lightning node (i.e, running or still initiating). An error will be returned if a lightning node was already running since only 1 lightning node is able to run from each instance of AtomicDEX.

<Note>
Any methods with a `task::` prefix will be linked to a numeric `task_id` value which is used to query the status or outcome of the task.
</Note>

### Request Parameters

| Parameter            | Type    | Description                                     |
|----------------------|---------|-------------------------------------------------|
| ticker               | string  | Ticker of coin to activate                      |
| activation_params    | object  | A standard [LightningActivationParams](/atomicdex/api/v20#LightningActivationParams) object.   |


#### ðŸ“Œ Example

<CodeGroup title="" tag="POST" label="task::enable_lightning::init">
```json {{ mm2MethodDecorate : true }}
{
    "method": "task::enable_lightning::init",
    "userpass": "MM2_RPC_PASSWORD",
    "mmrpc": "2.0",
    "params": {
        "ticker": "tBTC-TEST-lightning",
        "activation_params": {
            "name": "AtomicDEX-Docs-Node-1",
            "listening_port": 9735,
            "color": "000000",
            "payment_retries": 5
        }
    },
    "id": 2
}
```
</CodeGroup>


<CollapsibleSection expandedText='Hide Response' collapsedText='Show Response'>

#### Response

```json
{
    "mmrpc": "2.0",
    "result": {
        "task_id": 1
    },
    "id": null
}
```
</CollapsibleSection>


## status

The `task::enable_lightning::status` request checks the status of lightning node initialization.

### Request Parameters

| Parameter            | Type    | Description                                                                                                                 |
|----------------------|---------|---------------------------------------------------------------------------------------------------------------------------- |
| task_id              | integer | The task id returned from `task::enable_lightning::init`                                                                    |
| forget_if_finished   | boolean | Optional, defaults to `true`. If `false`, the status of the `task_id` will still be available after the task has completed. |


#### ðŸ“Œ Example

<CodeGroup title="" tag="POST" label="task::enable_lightning::status">
```json {{ mm2MethodDecorate : true }}
{
    "userpass": "MM2_RPC_PASSWORD",
    "mmrpc": "2.0",
    "method": "task::enable_lightning::status",
    "params": {
        "task_id": 1,
        "forget_if_finished": false
    },
    "id": 2
}
```
</CodeGroup>


<CollapsibleSection expandedText='Hide Response' collapsedText='Show Response'>

#### Response (ready, success)

```json
{
    "mmrpc": "2.0",
    "result": {
        "status": "Ok",
        "details": {
            "platform_coin": "BTC-segwit",
            "address": "0321937a095229510bd2b02a930d7b7eb273147e348ef1086b22e8790e3c609804",
            "balance": {
                "spendable": "0",
                "unspendable": "0"
            }
        }
    },
    "id": null
}
```
<Note>
In the above response spendable will always be 0 since the balance is unspendable until connections with lightning channels counterparties are established.
Using the [my_balance](ADD LINK HERE) method after the coin is activated will get the spendable balance depending on how many channel counterparties are online.
For exact channels balances and which channels are usable, there is a [different RPC](ADD LINK HERE) that will be documented in upcoming comments.
</Note>
</CollapsibleSection>

<CollapsibleSection expandedText='Hide Response' collapsedText='Show Response'>
#### Response (in progress state)

```json
{
    "mmrpc": "2.0",
    "result": {
        "status": "InProgress",
        "details": "ReadingNetworkGraphFromFile"
    },
    "id": null
}
```
Possible in progress statuses:
 - ActivatingCoin
 - GettingFeesFromRPC
 - ReadingNetworkGraphFromFile
 - InitializingChannelManager
 - InitializingPeerManager
 - ReadingScorerFromFile
 - InitializingBackgroundProcessor
 - ReadingChannelsAddressesFromFile

</CollapsibleSection>


## cancel

The `task::enable_lightning::cancel` request cancels lightning node initialization.

### Request Parameters

| Parameter            | Type    | Description                                                                                                                 |
|----------------------|---------|---------------------------------------------------------------------------------------------------------------------------- |
| task_id              | integer | The task id returned from `task::enable_lightning::init`                                                                    |


#### ðŸ“Œ Example

<CodeGroup title="" tag="POST" label="task::enable_lightning::cancel">
```json {{ mm2MethodDecorate : true }}
{
    "userpass": "MM2_RPC_PASSWORD",
    "mmrpc": "2.0",
    "method": "task::enable_lightning::cancel",
    "params": {
        "task_id": 1
    },
    "id": 1
}
```
</CodeGroup>

<CollapsibleSection expandedText='Hide Response' collapsedText='Show Response'>

#### Response

```json
{
    "mmrpc": "2.0",
    "result": "success",
    "id": null
}
```
</CollapsibleSection>

























### ERROR MESSAGES

On init where coin not in coins file
```
{'mmrpc': '2.0', 'error': 'Layer 2 tBTC-lightning config is not found', 'error_path': 'init_l2.prelude', 'error_trace': 'init_l2:82] prelude:82]', 'error_type': 'L2ConfigIsNotFound', 'error_data': 'tBTC-lightning', 'id': 2}
```

On init where coin exists but is wrong type
```
{'mmrpc': '2.0', 'error': 'Unexpected layer 2 protocol UTXO for tBTC-segwit', 'error_path': 'init_l2.prelude.lightning_activation', 'error_trace': 'init_l2:82] prelude:93] lightning_activation:92]', 'error_type': 'UnexpectedL2Protocol', 'error_data': {'ticker': 'tBTC-segwit', 'protocol': {'type': 'UTXO'}}, 'id': 2}
```

On init where address already in use
```
{
    "mmrpc": "2.0",
    "result": {
        "status": "Error",
        "details": {
            "error": "I/O error Address already in use (os error 48)",
            "error_path": "lib.lightning_activation.ln_p2p",
            "error_trace": "lib:103] lightning_activation:280] ln_p2p:196]",
            "error_type": "Internal",
            "error_data": "I/O error Address already in use (os error 48)"
        }
    },
    "id": null
}
```

On init if coin not activated
```
{'mmrpc': '2.0', 'error': 'Platform coin tBTC-TEST-lightning is not activated', 'error_path': 'init_l2.lp_coins', 'error_trace': 'init_l2:87] lp_coins:3087]', 'error_type': 'PlatformCoinIsNotActivated', 'error_data': 'tBTC-TEST-lightning', 'id': 2}
```

On init if missing config{'mmrpc': '2.0', 'error': "Invalid config for platform coin: tBTC-segwit, error: 'avg_blocktime' field is not found in platform coin config", 'error_path': 'init_l2.lightning_activation', 'error_trace': 'init_l2:95] lightning_activation:254]', 'error_type': 'InvalidPlatformConfiguration', 'error_data': {'platform_coin_ticker': 'tBTC-segwit', 'err': "'avg_blocktime' field is not found in platform coin config"}, 'id': 2}


On cancel when already completed
```
{
    "mmrpc": "2.0",
    "error": "Task is finished already",
    "error_path": "init_l2.manager",
    "error_trace": "init_l2:157] manager:104]",
    "error_type": "TaskFinished",
    "error_data": TASK_ID,
    "id": null
}
```
